---
import { getCollection, type CollectionEntry } from 'astro:content'
import { Image } from 'astro:assets'
import Layout from '../../../layouts/Layout.astro'

type Props = {
  posts: CollectionEntry<'posts'>[]
}

export async function getStaticPaths() {
  const posts = await getCollection('posts')
  const genres = [
    ...new Set(
      posts
        .filter((post) => {
          return post.data.genre
        })
        .map((post) => {
          return post.data.genre
        })
    )
  ]

  return genres.map((genre) => {
    return { params: { genre: genre }, props: { posts } }
  })
}

const { posts } = Astro.props
const { genre } = Astro.params
const genrePosts = posts.filter((post) => post.data.genre === genre)

const images = import.meta.glob<{ default: ImageMetadata }>(
  '/src/assets/posts/**/*.{png,jpg}'
)
---

<Layout title="Welcome to Astro.">
  <main>
    <h1>{genre}</h1>

    <ul>
      {
        genrePosts.map((post) => {
          const thumbnail =
            images[`/src/assets/posts/${post.slug}/thumbnail.jpg`] ||
            images[`/src/assets/posts/${post.slug}/thumbnail.png`] ||
            images[`/src/assets/posts/${genre}/thumbnail.jpg`] ||
            images[`/src/assets/posts/${genre}/thumbnail.png`] ||
            images[`/src/assets/posts/thumbnail.jpg`] ||
            images[`/src/assets/posts/thumbnail.png`]

          return (
            <li>
              <a href={`/posts/${post.slug}`}>{post.data.title}</a>
              <Image src={thumbnail()} alt="A bird." />
            </li>
          )
        })
      }
    </ul>
  </main>
</Layout>

<style></style>
