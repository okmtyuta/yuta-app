---
import { type CollectionEntry } from 'astro:content'
import { Image } from 'astro:assets'
import Layout from '../../../layouts/Layout.astro'
import { PostsService } from '../../../services/posts/posts.service'

type Props = {
  posts: CollectionEntry<'posts'>[]
  service: PostsService
}

export async function getStaticPaths() {
  const service = await PostsService.init()
  const genres = service.getGenres()

  return genres.map((genre) => {
    return { params: { genre: genre }, props: { service } }
  })
}

const { service } = Astro.props
const { genre } = Astro.params
const genrePosts = service.findByGenres([genre])

const images = import.meta.glob<{ default: ImageMetadata }>(
  '/src/assets/posts/**/*.{png,jpg}'
)
---

<Layout title={genre}>
  <main>
    <h1>{genre}</h1>

    <ul>
      {
        genrePosts.map((post) => {
          const thumbnail =
            images[`/src/assets/posts/${post.slug}/thumbnail.jpg`] ||
            images[`/src/assets/posts/${post.slug}/thumbnail.png`] ||
            images[`/src/assets/posts/${genre}/thumbnail.jpg`] ||
            images[`/src/assets/posts/${genre}/thumbnail.png`] ||
            images[`/src/assets/posts/thumbnail.jpg`] ||
            images[`/src/assets/posts/thumbnail.png`]

          return (
            <li>
              <a href={`/posts/${post.slug}`}>{post.data.title}</a>
              <Image src={thumbnail()} alt="A bird." />
            </li>
          )
        })
      }
    </ul>
  </main>
</Layout>

<style></style>
